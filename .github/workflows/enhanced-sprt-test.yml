name: Enhanced SPRT Testing

on:
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Test ID from dashboard'
        required: true
      dev_config:
        description: 'Dev triple: repo:branch:sha'
        required: true
        default: 'myfish:main:'
      base_config:
        description: 'Base triple: repo:branch:sha'
        required: true
        default: 'myfish:main:'
      test_config:
        description: 'Elo/time/games: elo0:elo1:tc_base:tc_inc:max_games'
        required: true
        default: '0.0:2.5:8.0:0.08:50000'

permissions:
  contents: read

env:
  DASHBOARD_URL: ${{ secrets.DASHBOARD_URL || 'http://localhost:3000' }}

jobs:
  sprt_test:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours
    
    steps:
      - name: Update test status to running
        continue-on-error: true
        run: |
          curl -X PUT "${{ env.DASHBOARD_URL }}/api/tests" \
            -H "Content-Type: application/json" \
            -d '{"id": "${{ github.event.inputs.test_id }}", "status": "running"}'

      - name: Parse combined inputs
        id: parse
        shell: bash
        run: |
          # dev_config: repo:branch:sha
          IFS=':' read -r DEV_REPO DEV_BRANCH DEV_SHA <<< "${{ github.event.inputs.dev_config }}"
          echo "DEV_REPO=$DEV_REPO" >> $GITHUB_ENV
          echo "DEV_BRANCH=$DEV_BRANCH" >> $GITHUB_ENV
          echo "DEV_SHA=$DEV_SHA" >> $GITHUB_ENV

          # base_config: repo:branch:sha
          IFS=':' read -r BASE_REPO BASE_BRANCH BASE_SHA <<< "${{ github.event.inputs.base_config }}"
          echo "BASE_REPO=$BASE_REPO" >> $GITHUB_ENV
          echo "BASE_BRANCH=$BASE_BRANCH" >> $GITHUB_ENV
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV

          # test_config: elo0:elo1:tc_base:tc_inc:max_games
          IFS=':' read -r ELO0 ELO1 TC_BASE TC_INC MAX_GAMES <<< "${{ github.event.inputs.test_config }}"
          echo "ELO0=$ELO0" >> $GITHUB_ENV
          echo "ELO1=$ELO1" >> $GITHUB_ENV
          echo "TC_BASE=$TC_BASE" >> $GITHUB_ENV
          echo "TC_INC=$TC_INC" >> $GITHUB_ENV
          echo "MAX_GAMES=$MAX_GAMES" >> $GITHUB_ENV

      - name: Checkout testing scripts
        uses: actions/checkout@v4
        with:
          repository: mike-koala-bear/MyfishNNUE
          path: testing
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout dev engine source
        uses: actions/checkout@v4
        with:
          repository: mike-koala-bear/${{ env.DEV_REPO }}
          ref: ${{ env.DEV_SHA || env.DEV_BRANCH }}
          path: dev
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          fetch-depth: 0

      - name: Checkout base engine source
        uses: actions/checkout@v4
        with:
          repository: mike-koala-bear/${{ env.BASE_REPO }}
          ref: ${{ env.BASE_SHA || env.BASE_BRANCH }}
          path: base
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests chess python-chess cutechess

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential g++ ninja-build

      - name: Build dev engine
        run: |
          cd dev
          if [ -d "src" ]; then
            # Build from source
            mkdir -p build
            cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -G Ninja
            ninja
            cd ..
            ENGINE_PATH="build/myfish"
          else
            echo "Error: No src directory found"
            exit 1
          fi
          
          # Get engine info
          DEV_BENCH=$($ENGINE_PATH bench 2>&1 | grep -oP 'Nodes searched: \K\d+' || echo "0")
          DEV_SHA=$(git rev-parse HEAD)
          DEV_MSG=$(git log -1 --pretty=%B | head -n 1)
          DEV_AUTHOR=$(git log -1 --pretty=%an)
          DEV_DATE=$(git log -1 --pretty=%ai)
          
          echo "DEV_BENCH=$DEV_BENCH" >> $GITHUB_ENV
          echo "DEV_SHA=$DEV_SHA" >> $GITHUB_ENV
          echo "DEV_MSG=$DEV_MSG" >> $GITHUB_ENV
          echo "DEV_AUTHOR=$DEV_AUTHOR" >> $GITHUB_ENV
          echo "DEV_DATE=$DEV_DATE" >> $GITHUB_ENV
          echo "DEV_ENGINE=$(pwd)/$ENGINE_PATH" >> $GITHUB_ENV

      - name: Build base engine
        run: |
          cd base
          if [ -d "src" ]; then
            mkdir -p build
            cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -G Ninja
            ninja
            cd ..
            ENGINE_PATH="build/myfish"
          else
            echo "Error: No src directory found"
            exit 1
          fi
          
          # Get engine info
          BASE_BENCH=$($ENGINE_PATH bench 2>&1 | grep -oP 'Nodes searched: \K\d+' || echo "0")
          BASE_SHA=$(git rev-parse HEAD)
          BASE_MSG=$(git log -1 --pretty=%B | head -n 1)
          BASE_AUTHOR=$(git log -1 --pretty=%an)
          BASE_DATE=$(git log -1 --pretty=%ai)
          
          echo "BASE_BENCH=$BASE_BENCH" >> $GITHUB_ENV
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          echo "BASE_MSG=$BASE_MSG" >> $GITHUB_ENV
          echo "BASE_AUTHOR=$BASE_AUTHOR" >> $GITHUB_ENV
          echo "BASE_DATE=$BASE_DATE" >> $GITHUB_ENV
          echo "BASE_ENGINE=$(pwd)/$ENGINE_PATH" >> $GITHUB_ENV

      - name: Update test with engine info
        continue-on-error: true
        run: |
          curl -X PUT "${{ env.DASHBOARD_URL }}/api/tests" \
            -H "Content-Type: application/json" \
            -d '{
              "id": "${{ github.event.inputs.test_id }}",
              "dev": {
                "bench": '"$DEV_BENCH"',
                "sha": "'"$DEV_SHA"'",
                "commitMessage": "'"$DEV_MSG"'",
                "commitAuthor": "'"$DEV_AUTHOR"'",
                "commitDate": "'"$DEV_DATE"'"
              },
              "base": {
                "bench": '"$BASE_BENCH"',
                "sha": "'"$BASE_SHA"'",
                "commitMessage": "'"$BASE_MSG"'",
                "commitAuthor": "'"$BASE_AUTHOR"'",
                "commitDate": "'"$BASE_DATE"'"
              }
            }'

      - name: Download opening book
        run: |
          mkdir -p books
          cd books
          # Download a small opening book
          wget -q https://github.com/official-stockfish/books/raw/master/8moves_v3.pgn.zip || true
          if [ -f 8moves_v3.pgn.zip ]; then
            unzip -q 8moves_v3.pgn.zip
          fi

      - name: Run SPRT test
        id: sprt
        run: |
          cd testing
          python3 sprt-runner.py \
            --engine1 "$DEV_ENGINE" \
            --engine2 "$BASE_ENGINE" \
            --test-id "${{ github.event.inputs.test_id }}" \
            --elo0 "$ELO0" \
            --elo1 "$ELO1" \
            --tc-base "$TC_BASE" \
            --tc-inc "$TC_INC" \
            --max-games "$MAX_GAMES" \
            --dashboard-url "${{ env.DASHBOARD_URL }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.event.inputs.test_id }}
          path: |
            testing/test_result_*.json
          retention-days: 30

      - name: Update final status
        if: always()
        continue-on-error: true
        run: |
          STATUS="failed"
          if [ "${{ steps.sprt.outcome }}" == "success" ]; then
            STATUS="passed"
          fi
          
          curl -X PUT "${{ env.DASHBOARD_URL }}/api/tests" \
            -H "Content-Type: application/json" \
            -d '{"id": "${{ github.event.inputs.test_id }}", "status": "'"$STATUS"'"}'

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const testId = '${{ github.event.inputs.test_id }}';
            const status = '${{ steps.sprt.outcome }}';
            
            const body = `## SPRT Test Results
            
            **Test ID**: \`${testId}\`
            **Status**: ${status === 'success' ? '✅ PASSED' : '❌ FAILED'}
            
            **Engines**:
            - Dev: \`${{ env.DEV_REPO }}@${{ env.DEV_SHA }}\`
            - Base: \`${{ env.BASE_REPO }}@${{ env.BASE_SHA }}\`
            
            **Configuration**:
            - Elo bounds: [${{ env.ELO0 }}, ${{ env.ELO1 }}]
            - Time control: ${{ env.TC_BASE }}+${{ env.TC_INC }}
            
            View full results in the [dashboard](${{ env.DASHBOARD_URL }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });
